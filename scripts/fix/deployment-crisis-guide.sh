#!/bin/bash

echo "ğŸš¨ VidaduAcademy Deployment Crisis Analysis"
echo "============================================"
echo ""

echo "ğŸ” SYMPTOM: All endpoints returning 404"
echo "This indicates the Laravel application is not serving requests properly."
echo ""

echo "ğŸ“‹ CRITICAL CHECKLIST - Verify these in Render Dashboard:"
echo ""
echo "1. ğŸ”§ SERVICE STATUS:"
echo "   - Is the service 'Running' (green) or 'Failed' (red)?"
echo "   - Check the 'Events' tab for deployment errors"
echo "   - Look at 'Logs' tab for startup errors"
echo ""

echo "2. ğŸŒ ENVIRONMENT VARIABLES:"
echo "   Required variables that MUST be set:"
echo "   âœ“ DATABASE_URL (from PostgreSQL add-on)"
echo "   âœ“ APP_KEY (generate with: php artisan key:generate --show)"
echo "   âœ“ APP_ENV=production"
echo "   âœ“ APP_DEBUG=false"
echo "   âœ“ STRIPE_KEY, STRIPE_SECRET, STRIPE_WEBHOOK_SECRET"
echo ""

echo "3. ğŸ“¦ BUILD PROCESS:"
echo "   Check if these build steps completed successfully:"
echo "   âœ“ Composer install"
echo "   âœ“ NPM install (if frontend assets)"
echo "   âœ“ Laravel setup (config cache, route cache)"
echo "   âœ“ Apache/PHP configuration"
echo ""

echo "4. ğŸ—„ï¸  DATABASE CONNECTION:"
echo "   âœ“ PostgreSQL add-on is created and 'Available'"
echo "   âœ“ DATABASE_URL is automatically populated"
echo "   âœ“ Database migrations can run"
echo ""

echo "5. ğŸ”’ FILE PERMISSIONS:"
echo "   Laravel requires write access to:"
echo "   âœ“ storage/ directory (logs, cache, sessions)"
echo "   âœ“ bootstrap/cache/ directory"
echo ""

echo "ğŸ› ï¸  IMMEDIATE ACTIONS TO TAKE:"
echo ""
echo "A. CHECK RENDER DASHBOARD:"
echo "   1. Go to https://dashboard.render.com"
echo "   2. Find 'vidaduacademy-backend' service"
echo "   3. Check 'Events' tab for deployment errors"
echo "   4. Check 'Logs' tab for runtime errors"
echo "   5. Verify 'Environment' tab has all required variables"
echo ""

echo "B. IF BUILD FAILED:"
echo "   - Look for errors in build logs"
echo "   - Common issues: missing dependencies, permission errors, invalid PHP"
echo "   - Check nixpacks.toml configuration"
echo ""

echo "C. IF BUILD SUCCEEDED BUT SERVICE WON'T START:"
echo "   - Check runtime logs for PHP/Apache errors"
echo "   - Verify DATABASE_URL format and connectivity"
echo "   - Check if start-render.sh script is executing properly"
echo ""

echo "ğŸ“ EMERGENCY FIXES:"
echo ""
echo "1. QUICK APP_KEY GENERATION:"
echo "   Run locally: cd backend && php artisan key:generate --show"
echo "   Copy the output (starts with 'base64:') to Render environment"
echo ""

echo "2. DATABASE_URL FORMAT:"
echo "   Should look like: postgresql://username:password@host:port/database"
echo "   Render auto-populates this when PostgreSQL add-on is connected"
echo ""

echo "3. MANUAL REDEPLOY:"
echo "   In Render Dashboard â†’ Service â†’ 'Manual Deploy' â†’ Deploy latest commit"
echo ""

echo "ğŸ”„ FALLBACK DIAGNOSTIC:"
echo "If the issue persists, the start-render.sh script includes SQLite fallback."
echo "Check logs to see if it's falling back to SQLite due to DB connection issues."
echo ""

echo "ğŸ“± CURRENT DEPLOYMENT STATUS CHECK:"
deployment_time=$(curl -s -I "https://vidaduacademy-backend.onrender.com/" | grep -i date | cut -d' ' -f2-)
if [ -n "$deployment_time" ]; then
    echo "   Server last responded: $deployment_time"
    echo "   âœ… Service is reachable but not serving Laravel"
else
    echo "   âŒ Service is completely unreachable"
fi

echo ""
echo "ğŸš€ After making changes in Render Dashboard:"
echo "   Wait 2-3 minutes for deployment to complete"
echo "   Then run: ./database-check.sh"
echo ""
echo "ğŸ’¡ If you need immediate help debugging:"
echo "   1. Share the Render build/deployment logs"
echo "   2. Confirm all environment variables are set"
echo "   3. Check PostgreSQL add-on status"
echo ""
echo "ğŸ Crisis analysis complete - $(date)"
