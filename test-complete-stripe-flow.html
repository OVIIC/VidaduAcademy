<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Stripe Checkout - VidaduAcademy</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 50px auto; 
            padding: 20px; 
        }
        .test-section { 
            border: 1px solid #ddd; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 5px; 
        }
        button { 
            background: #007cba; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        button:hover { background: #005a87; }
        .result { 
            background: #f9f9f9; 
            padding: 10px; 
            margin: 10px 0; 
            border-left: 4px solid #007cba; 
        }
        .error { border-left-color: #dc3545; }
        .success { border-left-color: #28a745; }
    </style>
</head>
<body>
    <h1>VidaduAcademy - Test Stripe Checkout Flow</h1>
    
    <div class="test-section">
        <h2>1. Test API Connectivity</h2>
        <button onclick="testAPI()">Test API Connection</button>
        <div id="api-result" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>2. Load Available Courses</h2>
        <button onclick="loadCourses()">Load Courses</button>
        <div id="courses-result" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>3. Test Login (Required for Purchase)</h2>
        <input type="email" id="email" placeholder="Email" value="test@example.com">
        <input type="password" id="password" placeholder="Password" value="password">
        <button onclick="testLogin()">Test Login</button>
        <div id="login-result" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>4. Create Checkout Session</h2>
        <label>Course ID: <input type="number" id="courseId" value="1"></label>
        <button onclick="createCheckout()">Create Stripe Checkout</button>
        <div id="checkout-result" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>5. Test Payment Success Page</h2>
        <input type="text" id="sessionId" placeholder="Session ID (from step 4)">
        <button onclick="testPaymentSuccess()">Test Payment Success</button>
        <button onclick="openPaymentSuccessPage()">Open Payment Success Page</button>
        <div id="payment-result" class="result" style="display:none;"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        let authToken = null;

        function showResult(elementId, content, isError = false, isSuccess = false) {
            const element = document.getElementById(elementId);
            element.innerHTML = content;
            element.style.display = 'block';
            element.className = 'result' + (isError ? ' error' : isSuccess ? ' success' : '');
        }

        async function testAPI() {
            try {
                const response = await fetch(`${API_BASE}/courses`);
                const data = await response.json();
                showResult('api-result', `✅ API connected! Found ${data.data.length} courses.`, false, true);
            } catch (error) {
                showResult('api-result', `❌ API connection failed: ${error.message}`, true);
            }
        }

        async function loadCourses() {
            try {
                const response = await fetch(`${API_BASE}/courses`);
                const data = await response.json();
                let html = '<h3>Available Courses:</h3>';
                data.data.forEach(course => {
                    html += `<p><strong>ID ${course.id}:</strong> ${course.title} - $${course.price}</p>`;
                });
                showResult('courses-result', html, false, true);
            } catch (error) {
                showResult('courses-result', `❌ Failed to load courses: ${error.message}`, true);
            }
        }

        async function testLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                if (data.token) {
                    authToken = data.token;
                    showResult('login-result', `✅ Login successful! Token: ${data.token.substring(0, 20)}...`, false, true);
                } else {
                    showResult('login-result', `❌ Login failed: ${JSON.stringify(data)}`, true);
                }
            } catch (error) {
                showResult('login-result', `❌ Login error: ${error.message}`, true);
            }
        }

        async function createCheckout() {
            if (!authToken) {
                showResult('checkout-result', '❌ Please login first!', true);
                return;
            }

            const courseId = document.getElementById('courseId').value;
            
            try {
                const response = await fetch(`${API_BASE}/payments/create-checkout-session`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ 
                        course_id: parseInt(courseId),
                        success_url: 'http://localhost:3002/payment/success?session_id={CHECKOUT_SESSION_ID}',
                        cancel_url: 'http://localhost:3002/courses'
                    })
                });
                
                const data = await response.json();
                if (data.checkout_url) {
                    showResult('checkout-result', `✅ Checkout session created!<br>
                        <a href="${data.checkout_url}" target="_blank">Open Stripe Checkout</a><br>
                        <small>Session ID will be in the URL after payment</small>`, false, true);
                } else {
                    showResult('checkout-result', `❌ Checkout failed: ${JSON.stringify(data)}`, true);
                }
            } catch (error) {
                showResult('checkout-result', `❌ Checkout error: ${error.message}`, true);
            }
        }

        async function testPaymentSuccess() {
            const sessionId = document.getElementById('sessionId').value;
            if (!sessionId) {
                showResult('payment-result', '❌ Please enter a session ID first!', true);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/payments/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ session_id: sessionId })
                });
                
                const data = await response.json();
                if (data.success) {
                    showResult('payment-result', `✅ Payment verified!<br>
                        Course: ${data.course.title}<br>
                        Amount: $${data.payment.amount} ${data.payment.currency.toUpperCase()}`, false, true);
                } else {
                    showResult('payment-result', `❌ Payment verification failed: ${JSON.stringify(data)}`, true);
                }
            } catch (error) {
                showResult('payment-result', `❌ Payment verification error: ${error.message}`, true);
            }
        }

        function openPaymentSuccessPage() {
            const sessionId = document.getElementById('sessionId').value;
            const url = sessionId 
                ? `http://localhost:3002/payment/success?session_id=${sessionId}`
                : 'http://localhost:3002/payment/success';
            window.open(url, '_blank');
        }

        // Auto-test API on load
        window.onload = () => {
            testAPI();
        };
    </script>
</body>
</html>
